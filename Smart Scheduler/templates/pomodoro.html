<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pomodoro Timer - Smart Scheduler</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .pomodoro-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 40px auto;
            max-width: 420px;
            background: #18132b;
            border-radius: 14px;
            box-shadow: 0 0 22px #255dcc88;
            padding: 28px;
            text-align: center;
        }
        #timer {
            font-size: 3rem;
            letter-spacing: 2px;
            color: #4aa3ff;
            text-shadow: 0 0 14px #4aa3ff;
            margin-bottom: 15px;
        }
        #status {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #ff3445;
        }
        .form-row {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        select, input[type='number'] {
            background: #23253b;
            color: #fff;
            border: 1px solid #349cff;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 1rem;
        }
        button {
            background: #349cff;
            color: #fff;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            padding: 8px 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px #1db9c3a8;
            transition: 0.2s;
        }
        button:hover {
            background: #ff3445;
        }
        #buzzer-section {
            margin-top: 20px;
        }
        #buzzer-section button {
            background: #ff3445;
            padding: 8px 20px;
        }
        .desc-txt {
            font-size: 0.9rem;
            color: #f1f2f6;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<header class="hdr-gradient">
    <h1 class="cool-title">‚è±Ô∏è Pomodoro Timer</h1>
</header>

<div class="pomodoro-container animate-fade">
    <div id="status">{{ session.mode if session else 'Stopped' }}</div>
    <div id="timer">00:00</div>

    <form method="post">
        <div class="form-row">
            <select name="preset" id="preset-select" onchange="toggleCustomFields()">
                <option value="25-5">üïí 25 min / 5 min break</option>
                <option value="25-10">üïë 25 min / 10 min break</option>
                <option value="30-0">üïì 30 min work only</option>
                <option value="custom">‚ú® Custom</option>
            </select>
            <div id="custom-fields" style="display:none;">
                <input type="number" name="custom_work" min="1" max="180" value="25" placeholder="Work (min)">
                <input type="number" name="custom_break" min="0" max="60" value="5" placeholder="Break (min)">
            </div>
        </div>
        <div class="form-row">
            <button name="action" value="start">‚ñ∂ Start</button>
            <button name="action" value="stop">‚è∏ Stop</button>
            <button name="action" value="reset">‚ôª Reset</button>
        </div>
    </form>

    <div id="buzzer-section" style="display:none;">
        <form method="post">
            <button name="action" value="ok" type="submit">OK</button>
            <div class="desc-txt">Press OK to stop buzzer</div>
        </form>
    </div>
</div>

<div style="text-align:center; margin-top:20px;">
    <a href="{{ url_for('home') }}">&#8592; Back to Home</a>
</div>

<audio 
    id="buzzer-audio" 
    src="https://www.myinstants.com/media/sounds/yt1s_Ro643q7.mp3"  
    type="audio/mpeg" 
    preload="auto">
    Your browser does not support the audio element.
</audio>

<script>
let audio = document.getElementById('buzzer-audio');
let buzzerStartTime = null;

function formatTime(secs){
    let m = Math.floor(secs/60).toString().padStart(2,'0');
    let s = (secs%60).toString().padStart(2,'0');
    return `${m}:${s}`;
}

// Unlock audio on first user click (browser rule)
document.body.addEventListener('click', () => {
    audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
    }).catch(err => {});
}, { once: true });

function updatePomodoro(){
    fetch("/pomodoro/status").then(res=>res.json()).then(data=>{
        if(data.running){
            // Running state
            document.getElementById('status').textContent = data.mode.charAt(0).toUpperCase()+data.mode.slice(1);
            document.getElementById('timer').textContent = formatTime(data.remaining);
            document.getElementById('buzzer-section').style.display = "none";
            audio.pause();
            audio.currentTime = 0;
            buzzerStartTime = null;
        } else {
            document.getElementById('timer').textContent = "00:00";
            if(data.buzzer){
                document.getElementById('buzzer-section').style.display = "block";
                if(!buzzerStartTime){
                    buzzerStartTime = Date.now();
                    audio.play().catch(err => console.log("Audio blocked until user click"));
                }
                // Stop after 1 minute automatically
                if(buzzerStartTime && (Date.now() - buzzerStartTime >= 60000)){
                    audio.pause();
                    audio.currentTime = 0;
                    document.getElementById('buzzer-section').style.display = "none";
                }
            } else {
                buzzerStartTime = null;
                document.getElementById('buzzer-section').style.display = "none";
                audio.pause();
                audio.currentTime = 0;
            }
        }
    });
}

function toggleCustomFields(){
    let preset = document.getElementById('preset-select').value;
    document.getElementById('custom-fields').style.display = preset === 'custom' ? 'inline-block' : 'none';
}

setInterval(updatePomodoro, 1000);
updatePomodoro();
toggleCustomFields();
</script>

</body>
</html>
